#!/bin/bash

DB_PATH="$HOME/.repty.db"
mkdir -p "$(dirname "$DB_PATH")"

# Init DB if it doesn't exist
if [ ! -f "$DB_PATH" ]; then
  sqlite3 "$DB_PATH" "
    CREATE TABLE IF NOT EXISTS commands (
      id INTEGER PRIMARY KEY,
      command TEXT,
      timestamp TEXT,
      cwd TEXT,
      exit_code INTEGER,
      git_project TEXT,
      session_id TEXT,
      keywords TEXT
    );
    CREATE INDEX IF NOT EXISTS idx_command ON commands(command);
  "
fi

# Extract keywords from a command
extract_keywords() {
  local cmd="$1"
  # Split command into words and take the first 5 words as keywords
  local keywords=$(echo "$cmd" | tr -s '[:space:]' ' ' | tr ' ' '\n' | grep -v '^$' | 
    grep -v -E '^(the|a|an|in|on|at|to|for|with|by|about|--.*)$' | 
    head -n 5 | tr '\n' ' ' | sed 's/ *$//')
  echo "$keywords"
}

# Insert log
repty_log_command() {
  local cmd="$1"
  local status="$2"
  local cwd="$PWD"
  local timestamp="$(date +'%Y-%m-%d %H:%M:%S')"
  local git_project="$(git rev-parse --show-toplevel 2>/dev/null || echo "")"
  local session_id="${REPTY_SESSION_ID:-$(uuidgen 2>/dev/null || date +%s)}"
  local keywords="$(extract_keywords "$cmd")"

  sqlite3 "$DB_PATH" <<EOF
INSERT INTO commands (command, timestamp, cwd, exit_code, git_project, session_id, keywords)
VALUES ('$cmd', '$timestamp', '$cwd', $status, '$git_project', '$session_id', '$keywords');
EOF
}
