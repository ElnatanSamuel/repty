#!/bin/bash

REPTY_LIB_DIR="$(dirname "$(realpath "$0")")/../lib"
SUBCOMMAND=$1
shift

# Extract keywords from a command
extract_keywords() {
  local cmd="$1"
  # Split command into words and take the first 5 words as keywords
  local keywords=$(echo "$cmd" | tr -s '[:space:]' ' ' | tr ' ' '\n' | grep -v '^$' | 
    grep -v -E '^(the|a|an|in|on|at|to|for|with|by|about|--.*)$' | 
    head -n 5 | tr '\n' ' ' | sed 's/ *$//')
  echo "$keywords"
}

case "$SUBCOMMAND" in
  find)
    "$REPTY_LIB_DIR/fuzzy_search.sh" "$@"
    ;;
  stats)
    "$REPTY_LIB_DIR/stats.sh" "$@"
    ;;
  export)
    "$REPTY_LIB_DIR/export.sh" "$@"
    ;;
  nlp)
    "$REPTY_LIB_DIR/nlp_search.sh" "$@"
    ;;
  log)
    EXIT_CODE="$1"
    shift  # Shift to remove the exit code parameter
    COMMAND="$*"  # Get all remaining arguments as the command
    
    if [[ "$COMMAND" == repty* || -z "$COMMAND" ]]; then
      exit 0
    fi
    
    CWD=$(pwd)
    TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
    
    GIT_PROJECT=""
    if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null; then
      GIT_PROJECT=$(git config --get remote.origin.url 2>/dev/null || echo "")
    fi
    
    SESSION_ID=${REPTY_SESSION_ID:-$(uuidgen 2>/dev/null || echo "session-$(date +%s)")}
    export REPTY_SESSION_ID="$SESSION_ID"
    
    COMMAND_ESC="${COMMAND//\'/\'\'}"
    CWD_ESC="${CWD//\'/\'\'}"
    GIT_PROJECT_ESC="${GIT_PROJECT//\'/\'\'}"
    KEYWORDS=$(extract_keywords "$COMMAND")
    KEYWORDS_ESC="${KEYWORDS//\'/\'\'}"
    
    sqlite3 "$HOME/.repty.db" <<EOF
INSERT INTO commands (command, timestamp, cwd, exit_code, git_project, session_id, keywords) 
VALUES ('$COMMAND_ESC', '$TIMESTAMP', '$CWD_ESC', $EXIT_CODE, '$GIT_PROJECT_ESC', '$SESSION_ID', '$KEYWORDS_ESC');
EOF
    ;;
  *)
    echo "Usage: repty [find <query> | stats | export | nlp <query> | log <exit_code> <command>]"
    exit 1
    ;;
esac
