#!/bin/bash

REPTY_LIB_DIR="$(dirname "$(realpath "$0")")/../lib"
SUBCOMMAND=$1
shift

case "$SUBCOMMAND" in
  find)
    "$REPTY_LIB_DIR/fuzzy_search.sh" "$@"
    ;;
  stats)
    "$REPTY_LIB_DIR/stats.sh" "$@"
    ;;
  export)
    "$REPTY_LIB_DIR/export.sh" "$@"
    ;;
  log)
    EXIT_CODE="$1"
    LAST_COMMAND=$(fc -ln -1 | sed 's/^\s*//')
    
    if [[ "$LAST_COMMAND" == repty* ]]; then
      exit 0
    fi
    
    CWD=$(pwd)
    TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
    
    GIT_PROJECT=""
    if command -v git &>/dev/null && git rev-parse --is-inside-work-tree &>/dev/null; then
      GIT_PROJECT=$(git config --get remote.origin.url 2>/dev/null || echo "")
    fi
    
    SESSION_ID=${REPTY_SESSION_ID:-$(uuidgen 2>/dev/null || echo "session-$(date +%s)")}
    export REPTY_SESSION_ID="$SESSION_ID"
    
    LAST_COMMAND_ESC="${LAST_COMMAND//\'/\'\'}"
    CWD_ESC="${CWD//\'/\'\'}"
    GIT_PROJECT_ESC="${GIT_PROJECT//\'/\'\'}"
    
    sqlite3 "$HOME/.repty.db" <<EOF
INSERT INTO commands (command, timestamp, cwd, exit_code, git_project, session_id) 
VALUES ('$LAST_COMMAND_ESC', '$TIMESTAMP', '$CWD_ESC', $EXIT_CODE, '$GIT_PROJECT_ESC', '$SESSION_ID');
EOF
    ;;
  *)
    echo "Usage: repty [find <query> | stats | export | log <exit_code>]"
    exit 1
    ;;
esac
